# 双节点支持功能需求文档

## 介绍

为 H UI 面板添加双节点支持功能，允许管理员配置一个通过现有 Hysteria2 节点作为 SOCKS5 出站的第二个节点，并为每个用户提供节点访问权限控制。

## 需求

### 需求 1：管理员节点配置

**用户故事：** 作为管理员，我想要能够配置一个通过现有 Hysteria2 节点作为 SOCKS5 出站的第二个节点，以便为用户提供更多的连接选择。

#### 验收标准

1. WHEN 管理员访问 Hysteria2 配置页面 THEN 系统 SHALL 显示一个"启用第二节点"的开关选项
2. WHEN 管理员启用第二节点 THEN 系统 SHALL 显示 SOCKS5 出站配置选项（地址、用户名、密码）
3. WHEN 管理员保存第二节点配置 THEN 系统 SHALL 验证配置有效性并启动第二个 Hysteria2 实例
4. WHEN 第二节点被禁用 THEN 系统 SHALL 停止第二个 Hysteria2 实例并清理相关资源

### 需求 2：用户节点权限控制

**用户故事：** 作为管理员，我想要为每个用户单独控制是否可以访问两个节点还是只能访问主节点，以便灵活管理用户权限。

#### 验收标准

1. WHEN 管理员编辑用户信息 THEN 系统 SHALL 显示"节点访问权限"选项（单节点/双节点）
2. WHEN 用户权限设置为单节点 THEN 该用户的订阅 SHALL 只包含主 Hysteria2 节点
3. WHEN 用户权限设置为双节点且第二节点已启用 THEN 该用户的订阅 SHALL 包含两个节点
4. WHEN 第二节点被管理员禁用 THEN 所有用户订阅 SHALL 自动回退到只包含主节点

### 需求 3：订阅服务兼容性

**用户故事：** 作为用户，我想要通过现有的订阅链接获取到我有权限访问的所有节点，以便无缝使用服务。

#### 验收标准

1. WHEN 用户访问订阅链接且只有单节点权限 THEN 系统 SHALL 返回主节点配置
2. WHEN 用户访问订阅链接且有双节点权限 THEN 系统 SHALL 返回两个节点的配置
3. WHEN 生成节点URL和二维码 THEN 系统 SHALL 根据用户权限显示相应的节点选项
4. WHEN 第二节点配置变更 THEN 系统 SHALL 自动更新所有相关用户的订阅内容

### 需求 4：系统稳定性和向下兼容

**用户故事：** 作为系统管理员，我想要确保新功能不会影响现有功能的稳定性，以便平滑升级。

#### 验收标准

1. WHEN 第二节点功能被禁用 THEN 系统 SHALL 完全按照原有单节点模式运行
2. WHEN 第二节点启动失败 THEN 系统 SHALL 记录错误日志但不影响主节点运行
3. WHEN 数据库升级 THEN 系统 SHALL 为现有用户设置默认的单节点权限
4. WHEN 配置导入导出 THEN 系统 SHALL 包含第二节点和用户权限配置

### 需求 5：UI集成和用户体验

**用户故事：** 作为管理员，我想要新功能能够自然地集成到现有界面中，以便不需要学习全新的操作方式。

#### 验收标准

1. WHEN 访问 Hysteria2 配置页面 THEN 第二节点配置 SHALL 作为现有配置的扩展部分显示
2. WHEN 编辑用户信息 THEN 节点权限控制 SHALL 与其他用户属性一起显示
3. WHEN 查看用户列表 THEN 系统 SHALL 显示每个用户的节点权限状态
4. WHEN 生成用户订阅URL THEN 界面 SHALL 根据用户权限动态显示可用节点选项