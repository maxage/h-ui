# 双节点支持功能实现计划

## 实现任务列表

- [x] 1. 扩展数据模型和常量定义
  - 在 model/constant/config.go 中添加第二节点相关常量
  - 在 model/entity/account.go 中添加 nodeAccess 字段
  - 创建 SOCKS5 配置相关的数据结构
  - _需求: 1.1, 2.1_

- [x] 2. 实现数据库迁移逻辑
  - 在 dao/init.go 中添加新配置项的初始化
  - 为 account 表添加 node_access 字段的迁移逻辑
  - 确保现有用户默认设置为单节点权限
  - _需求: 4.3_

- [x] 3. 扩展配置管理服务
  - 在 service/config.go 中添加第二节点配置管理函数
  - 实现 SOCKS5 出站配置的生成和验证逻辑
  - 添加配置完整性检查和错误处理
  - _需求: 1.2, 1.3_

- [x] 4. 实现第二节点实例管理
  - 在 service/hysteria2.go 中添加第二节点的启动停止逻辑
  - 实现独立的配置文件生成 (hysteria2-node2.yaml)
  - 添加端口自动分配逻辑 (主端口+1)
  - 实现双节点状态监控和错误隔离
  - _需求: 1.4, 4.2_

- [x] 5. 扩展用户权限管理
  - 在 service/account.go 中添加 nodeAccess 字段的处理逻辑
  - 修改用户创建和更新接口支持节点权限设置
  - 实现权限验证和默认值设置
  - _需求: 2.1, 2.2_

- [x] 6. 修改订阅生成逻辑
  - 在 service/hysteria2_api.go 中修改订阅生成函数
  - 根据用户 nodeAccess 权限动态生成节点列表
  - 实现多节点配置的不同客户端格式支持
  - 确保向下兼容现有订阅格式
  - _需求: 3.1, 3.2, 3.3_

- [x] 7. 扩展配置管理控制器
  - 在 controller/config.go 中添加第二节点配置接口
  - 添加 SOCKS5 配置的 CRUD 接口
  - 实现配置验证和错误响应处理
  - _需求: 1.1_

- [x] 8. 修改用户管理控制器
  - 在 controller/account.go 中扩展用户保存和更新接口
  - 添加 nodeAccess 字段的验证和处理逻辑
  - 确保权限变更的即时生效
  - _需求: 2.1, 2.2_

- [x] 9. 扩展前端配置页面
  - 在 frontend/src/views/config/hysteria2.vue 中添加第二节点配置区域
  - 实现第二节点开关和 SOCKS5 配置表单
  - 添加配置验证和状态显示
  - 集成到现有配置页面布局中
  - _需求: 5.1, 5.2_

- [x] 10. 扩展前端用户管理页面
  - 在 frontend/src/views/account/index.vue 中添加节点权限控制
  - 在用户列表中显示节点权限状态
  - 在用户编辑对话框中添加权限选择
  - 实现权限状态的动态更新
  - _需求: 5.2, 5.3_

- [x] 11. 扩展前端 API 接口
  - 在 frontend/src/api/config/index.ts 中添加第二节点相关接口
  - 在 frontend/src/api/account/index.ts 中扩展用户接口支持 nodeAccess
  - 添加相应的 TypeScript 类型定义
  - _需求: 5.4_

- [x] 12. 实现路由和中间件扩展
  - 在 router/config.go 中添加第二节点配置路由
  - 确保新接口的权限验证和中间件应用
  - 测试路由的正确性和安全性
  - _需求: 1.1_

- [x] 13. 添加配置导入导出支持
  - 在 controller/config.go 中扩展导入导出功能
  - 确保第二节点配置和用户权限的完整备份
  - 实现配置的向下兼容导入
  - _需求: 4.4_

- [x] 14. 实现错误处理和日志记录
  - 添加第二节点相关的错误处理逻辑
  - 实现详细的日志记录和状态监控
  - 确保错误不会影响主节点的正常运行
  - _需求: 4.2_

- [x] 15. 编写单元测试和集成测试
  - 为新增的配置管理功能编写单元测试
  - 为第二节点实例管理编写集成测试
  - 为用户权限控制编写端到端测试
  - 确保现有功能的回归测试通过
  - _需求: 4.1_

- [x] 16. 更新文档和部署脚本
  - 更新 README 文档说明新功能
  - 添加配置示例和使用说明
  - 确保部署脚本支持新的数据库迁移
  - 添加故障排除指南
  - _需求: 4.4_